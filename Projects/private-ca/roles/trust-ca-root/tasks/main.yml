---
- name: Copy Example Root CA certificate
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: root
    group: root
  loop:
    - {src: "ca.pem", dest: "/usr/local/share/ca-certificates/Example_Root_CA.crt" }

- name: Update TLS roots
  shell: update-ca-certificates

- name: Install cfssl
  apt:
    name:
      - golang-cfssl
    cache_valid_time: 240

- name: "Build hosts file"
  lineinfile: 
    dest: /etc/hosts
    regexp: '.*{{ hostvars[item].ansible_hostname }}$'
    line: "{{ hostvars[item].ansible_eth1.ipv4.address }} {{ hostvars[item].ansible_hostname }} {{ hostvars[item].ansible_hostname }}.cluster.local"
    state: present
  when: hostvars[item].ansible_eth1.ipv4.address is defined
  with_items: "{{ groups['control'] }}"
