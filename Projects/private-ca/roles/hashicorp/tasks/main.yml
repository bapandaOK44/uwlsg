---

- name: Install unzip
  apt:
    name: unzip
    state: present

- name: Download Hashicorp tools
  get_url:
    url: '{{ item.url }}'
    checksum: '{{ item.checksum }}'
    dest: '{{ item.dest }}'
  loop:
    - { url: "https://releases.hashicorp.com/consul/1.1.0/consul_1.1.0_linux_amd64.zip", dest: "/tmp/consul_1.1.0_linux_amd64.zip", checksum: "sha256:09c40c8b5be868003810064916d8460bff334ccfb59a5046390224b27e052c45" }
    - { url: "https://releases.hashicorp.com/vault/0.10.1/vault_0.10.1_linux_amd64.zip", dest: "/tmp/vault_0.10.1_linux_amd64.zip", checksum: "sha256:031e521b4603487126fd353a9557dd22a02304a8a11f843e9914be59a8009c8a" }
    - { url: "https://releases.hashicorp.com/nomad/0.8.3/nomad_0.8.3_linux_amd64.zip", dest: "/tmp/nomad_0.8.3_linux_amd64.zip", checksum: "sha256:c7faaee8fad0f6a74df01b9283253ee565f85791adca1d6a38462e0387dee175"}

- name: Install Hashicorp tools
  unarchive:
    src: '{{ item }}'
    dest: /usr/bin
    remote_src: yes
  loop:
    - "/tmp/consul_1.1.0_linux_amd64.zip"
    - "/tmp/vault_0.10.1_linux_amd64.zip"
    - "/tmp/nomad_0.8.3_linux_amd64.zip"

- name: Create configuration directories
  file:
    path: '{{ item }}'
    state: directory
  loop:
    - "/etc/consul"
    - "/etc/vault"
    - "/etc/nomad"

- name: Render configuration templates
  template:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - { src: "{{ consul_template_file }}", dest: "/etc/consul/consul-config.json" }
    - { src: "{{ nomad_template_file }}", dest: /etc/nomad/config.hcl }
    - { src: "vault.hcl.j2", dest: /etc/vault/config.hcl }

- name: Set environment variables
  lineinfile:
    line: "{{ item }}"
    path: /etc/environment
  loop:
    - "CONSUL_HTTP_ADDR=https://localhost:8500"
    - "CONSUL_CLIENT_KEY=/etc/ssl/cert-key.pem"
    - "CONSUL_CLIENT_CERT=/etc/ssl/cert.pem"
    - "NOMAD_ADDR=https://localhost:4646"
    - "NOMAD_CLIENT_KEY=/etc/ssl/cert-key.pem"
    - "NOMAD_CLIENT_CERT=/etc/ssl/cert.pem"
    - "VAULT_CLIENT_KEY=/etc/ssl/cert-key.pem"
    - "VAULT_CLIENT_CERT=/etc/ssl/cert.pem"

- name: Copy systemd unit file for Consul
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
  loop:
    - { src: "consul.service", dest: "/lib/systemd/system/consul.service"}
    - { src: "vault.service", dest: "/lib/systemd/system/vault.service"}
    - { src: "nomad.service", dest: "/lib/systemd/system/nomad.service"}

- name: Start services
  systemd:
    daemon_reload: yes
    name: "{{ item }}"
    enabled: yes
    state: started
  loop:
    - "consul"
    - "vault"
    - "nomad"
